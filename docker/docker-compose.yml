# Docker Compose for running CI tests locally
# Usage: docker compose -f docker/docker-compose.yml up --build

services:
  # Run all CI checks (format, clippy, test, docs)
  ci-all:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    environment:
      - CARGO_TERM_COLOR=always
      - RUSTFLAGS=-D warnings
    volumes:
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    mem_limit: 2g
    memswap_limit: 2g

  # Format check only
  fmt:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    command: cargo fmt --all -- --check
    environment:
      - CARGO_TERM_COLOR=always
    volumes:
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    mem_limit: 2g
    memswap_limit: 2g

  # Clippy lints only
  clippy:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    command: cargo clippy --all-targets --all-features -- -D warnings
    environment:
      - CARGO_TERM_COLOR=always
      - RUSTFLAGS=-D warnings
    volumes:
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    mem_limit: 2g
    memswap_limit: 2g

  # Tests only
  test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    command: cargo test --all-features --verbose
    environment:
      - CARGO_TERM_COLOR=always
      - RUSTFLAGS=-D warnings
    volumes:
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    mem_limit: 2g
    memswap_limit: 2g

  # Documentation build only
  docs:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    command: cargo doc --no-deps --all-features
    environment:
      - CARGO_TERM_COLOR=always
      - RUSTDOCFLAGS=-D warnings
    volumes:
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    mem_limit: 2g
    memswap_limit: 2g

  # Security audit only
  audit:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    command: sh -c "cargo audit || true"
    environment:
      - CARGO_TERM_COLOR=always
    volumes:
      - cargo-cache:/usr/local/cargo/registry
    mem_limit: 2g
    memswap_limit: 2g

  # MSRV check (Minimum Supported Rust Version)
  msrv:
    build:
      context: ..
      dockerfile: docker/Dockerfile.msrv
    command: cargo check --all-features
    environment:
      - CARGO_TERM_COLOR=always
    volumes:
      - cargo-cache:/usr/local/cargo/registry
      - target-cache-msrv:/app/target
    mem_limit: 2g
    memswap_limit: 2g

  # Install script test
  install-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.install-test
    environment:
      - VERBOSE=true
    mem_limit: 2g
    memswap_limit: 2g

  # ARM64 (aarch64) Linux tests using QEMU emulation
  # Requires: docker buildx create --use
  # Note: QEMU emulation is slow and memory-intensive; needs 8GB+ RAM
  test-arm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test-arm
    platform: linux/arm64
    command: cargo test --all-features --verbose
    environment:
      - CARGO_TERM_COLOR=always
      - RUSTFLAGS=-D warnings
    volumes:
      - cargo-cache-arm:/usr/local/cargo/registry
      - target-cache-arm:/app/target
    mem_limit: 8g
    memswap_limit: 12g

  # ARM64 all CI checks
  ci-all-arm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test-arm
    platform: linux/arm64
    environment:
      - CARGO_TERM_COLOR=always
      - RUSTFLAGS=-D warnings
    volumes:
      - cargo-cache-arm:/usr/local/cargo/registry
      - target-cache-arm:/app/target
    mem_limit: 8g
    memswap_limit: 12g

volumes:
  cargo-cache:
  target-cache:
  target-cache-msrv:
  cargo-cache-arm:
  target-cache-arm:
